/*
Matt Mannix
CPSC 425
Lab1 Pthreads

Using 1 threads and 16000000 tosses per core.
Pi is roughly 3.142184.

real	0m0.519s
user	0m0.514s
sys	0m0.005s
Using 2 threads and 8000000 tosses per core.
Pi is roughly 3.137971.

real	0m0.436s
user	0m0.859s
sys	0m0.001s
Using 4 threads and 4000000 tosses per core.
Pi is roughly 3.140115.

real	0m0.345s
user	0m1.230s
sys	0m0.009s
Using 8 threads and 2000000 tosses per core.
Pi is roughly 3.141950.

real	0m0.271s
user	0m2.012s
sys	0m0.005s
*/

#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>

#define TOTAL_TOSSES 16000000 //Number of tosses per thread.

int THREADS = 1;
int TOSSES = TOTAL_TOSSES;

void* toss (void* int_ptr) {
    int* seed = (int*) int_ptr;
    double* approx = malloc(sizeof(double));
    int hits = 0;
    double x; 
    double y;

    //Toss the darts
    int i;
    for(i = 0; i < TOSSES; i++) {
        x = ((double) rand_r(seed) / (double) RAND_MAX) * 2.0 - 1.0;
        y = ((double) rand_r(seed) / (double) RAND_MAX) * 2.0 - 1.0;
        
        //DEBUG
        #ifdef DEBUG
        printf("(%.02f, %.02f) ", x, y);
        printf("\tDistance = %.02f. ", ((x*x + y*y)) );
        printf("\tHit = %d.\n", ((x*x + y*y) <= 1) );
        #endif

        hits += ((x*x + y*y) <= 1);
    }
    //DEBUG
    #ifdef DEBUG
    printf("hits: %d tosses: %d.\n", hits, TOSSES); 
    #endif

    *approx = (4.0 * ((double) hits / (double) TOSSES));
    return (void*) approx;
}

int main(int argc, char** argv) {
    double approx = 0.0;
    int seed = 0;
    
    if(argc > 1) {
        THREADS = (int) argv[1][0] - '0';
        TOSSES = TOTAL_TOSSES / THREADS;
    }
    
    printf("Using %d threads and %d tosses per core.\n", THREADS, TOSSES);

    //Make some threads
    pthread_t threads[THREADS];
    
    //Spawn the threads
    int t;
    for(t = 0; t < THREADS; t++) {
        pthread_create(&threads[t], NULL, toss, &seed);
    }
    
    //Join threads
    for(t = 0; t < THREADS; t++) {
        double* partial;
        pthread_join(threads[t], (void**) &partial);
        
        //DEBUG
        #ifdef DEBUG
        printf("Approximation %d: Pi = %1.04f.\n", t, *partial);
        #endif
        
        approx += *partial;
        free(partial);
    }
    
    //Average the values in approx
    approx /= THREADS;

    //Print output and end
    printf("Pi is roughly %1.06f.\n", approx);
    pthread_exit(NULL);
}

